---
export interface Props {
  id: string;
  nombre: string;
  descripcion: string;
  precio: number;
  imagen: string | null;
  badge?: string | null;
}

const { id, nombre, descripcion, precio, imagen, badge } = Astro.props;

const hasImage = imagen && imagen !== 'null';

const precioFormateado = new Intl.NumberFormat('es-AR', {
  style: 'currency',
  currency: 'ARS',
  minimumFractionDigits: 0,
  maximumFractionDigits: 0,
}).format(precio);

// Badge colors — Papa Chula palette
const badgeColors: Record<string, { bg: string; text: string }> = {
  'Nuevo':       { bg: '#FFC520', text: '#1A1A1A' },
  'Oferta':      { bg: '#E52521', text: '#FDFDFD' },
  'XXL Gigante': { bg: '#1A1A1A', text: '#FFC520' },
  'XXL':         { bg: '#1A1A1A', text: '#FFC520' },
  'Gigante':     { bg: '#1A1A1A', text: '#FFC520' },
  'Especial':    { bg: '#FFC520', text: '#1A1A1A' },
  'Económica':   { bg: '#FDFDFD', text: '#1A1A1A' },
};
const badgeStyle = badge && badgeColors[badge] ? badgeColors[badge] : { bg: '#FFC520', text: '#1A1A1A' };
---

<!-- Compact horizontal list card -->
<article
  class="product-card theme-card group relative flex flex-row items-start gap-3 rounded-xl overflow-hidden border-[3px] border-[#1A1A1A] transition-all duration-200"
  data-product-id={id}
  data-product-nombre={nombre}
  data-product-precio={precio}
  style="padding: 10px; background: #FDFDFD; box-shadow: 4px 4px 0px #1A1A1A;"
>
  {hasImage && (
    <!-- LEFT: Square image (only when image exists) -->
    <div class="relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden">
      <img
        src={imagen}
        alt={nombre}
        class="w-full h-full object-cover transition-transform duration-400 group-hover:scale-105"
        loading="lazy"
        decoding="async"
        onerror="this.style.display='none'"
      />
      <!-- Badge overlay on image -->
      {badge && (
        <div
          class="absolute top-1 left-1 px-1.5 py-0.5 rounded text-xs font-black uppercase leading-none"
          style={`background: ${badgeStyle.bg}; color: ${badgeStyle.text}; font-size: 9px; letter-spacing: 0.03em;`}
        >
          {badge}
        </div>
      )}
    </div>
  )}

  <!-- RIGHT: Info -->
  <div class="flex-1 min-w-0 flex flex-col justify-between" style="min-height: 72px;">
    <!-- Top: name + optional inline badge + description -->
    <div>
      <div class="flex items-center gap-2 flex-wrap">
        <h3 class="theme-text font-bold text-sm leading-tight">
          {nombre}
        </h3>
        <!-- Inline badge when no image -->
        {!hasImage && badge && (
          <span
            class="px-1.5 py-0.5 rounded text-xs font-black uppercase leading-none flex-shrink-0"
            style={`background: ${badgeStyle.bg}; color: ${badgeStyle.text}; font-size: 9px; letter-spacing: 0.03em;`}
          >
            {badge}
          </span>
        )}
      </div>
      <p class="theme-muted text-xs leading-snug mt-0.5" style="display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;">
        {descripcion}
      </p>
    </div>

    <!-- Bottom: price + add button -->
    <div class="flex items-center justify-between mt-2">
      <span class="font-black text-lg" style="color: #1A1A1A; font-family: 'Bangers', cursive; letter-spacing: 0.03em;">
        {precioFormateado}
      </span>
      <button
        class="add-to-cart-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg font-black text-xs transition-all duration-150 active:scale-90 select-none border-2 border-[#1A1A1A]"
        data-product-id={id}
        data-product-nombre={nombre}
        data-product-precio={precio}
        style="background: #FFC520; color: #1A1A1A; font-family: 'Nunito', sans-serif; box-shadow: 3px 3px 0px #1A1A1A;"
        aria-label={`Agregar ${nombre} al carrito`}
      >
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Agregar
      </button>
    </div>
  </div>

  <!-- Added feedback flash -->
  <div
    class="added-feedback absolute inset-0 flex items-center justify-center rounded-xl opacity-0 pointer-events-none transition-opacity duration-300"
    style="background: rgba(229,37,33,0.10); border: 3px solid #E52521;"
  >
    <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border-2 border-[#1A1A1A]" style="background: #E52521; box-shadow: 3px 3px 0px #1A1A1A;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#FDFDFD" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <span class="text-xs font-black" style="color: #FDFDFD; font-family: 'Nunito', sans-serif;">¡Listo!</span>
    </div>
  </div>
</article>

<script>
  document.querySelectorAll<HTMLButtonElement>('.add-to-cart-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.productId!;
      const nombre = btn.dataset.productNombre!;
      const precio = Number(btn.dataset.productPrecio!);

      import('../stores/cartStore.js').then(({ addToCart }) => {
        addToCart({ id, nombre, precio });
      });

      const card = btn.closest('.product-card') as HTMLElement;
      const feedback = card?.querySelector('.added-feedback') as HTMLElement;
      if (feedback) {
        feedback.style.opacity = '1';
        setTimeout(() => { feedback.style.opacity = '0'; }, 600);
      }
    });
  });
</script>
